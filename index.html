<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Voxel Architect â€“ Mobile Hand Gesture FINAL</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<style>
body{
  margin:0;
  background:#000;
  overflow:hidden;
  font-family:monospace;
  touch-action:none;
}
#input_video{
  position:absolute;
  width:100vw;
  height:100vh;
  object-fit:cover;
  z-index:1;
}
#three_canvas{
  position:absolute;
  top:0;left:0;
  z-index:5;
  pointer-events:none;
}
#biometric_canvas{
  position:absolute;
  width:100vw;
  height:100vh;
  z-index:10;
  pointer-events:none;
}
#ui{
  position:absolute;
  top:10px;
  left:10px;
  z-index:100;
  background:rgba(0,0,0,0.65);
  color:#00f0ff;
  padding:12px;
  border-left:3px solid #00f0ff;
  font-size:12px;
}
.debug{color:#ffcc00;font-size:11px}
.stat{color:#fff}
</style>
</head>

<body>

<div id="ui">
  <div>ARCHITECT_OS â€“ MOBILE FINAL</div>
  <div>MODE: <span id="mode" class="stat">BOOT</span></div>
  <div>VOXELS: <span id="count" class="stat">0</span></div>
  <div class="debug">PINCH: <span id="dbgPinch">0</span></div>
  <div class="debug">TIMER: <span id="dbgTimer">0</span></div>
  <div class="debug">STATE: <span id="dbgState">---</span></div>
</div>

<video id="input_video" autoplay playsinline muted></video>
<canvas id="three_canvas"></canvas>
<canvas id="biometric_canvas"></canvas>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<script>
/* ========= UI ========= */
const video = document.getElementById("input_video");
const bioCanvas = document.getElementById("biometric_canvas");
const bioCtx = bioCanvas.getContext("2d");

const modeEl = document.getElementById("mode");
const countEl = document.getElementById("count");
const dbgPinch = document.getElementById("dbgPinch");
const dbgTimer = document.getElementById("dbgTimer");
const dbgState = document.getElementById("dbgState");

/* ========= THREE ========= */
const scene = new THREE.Scene();
const camera3D = new THREE.PerspectiveCamera(45, innerWidth/innerHeight, 0.1, 1000);
camera3D.position.z = 18;

const renderer = new THREE.WebGLRenderer({
  canvas: document.getElementById("three_canvas"),
  alpha:true,
  antialias:true
});
renderer.setSize(innerWidth, innerHeight);

scene.add(new THREE.AmbientLight(0xffffff,0.5));
const sun = new THREE.DirectionalLight(0x00f0ff,1);
sun.position.set(5,5,5);
scene.add(sun);

const voxelGroup = new THREE.Group();
scene.add(voxelGroup);

/* ========= VOXELS ========= */
const gridSize = 1.2;
const placed = new Map();

function createCube(x,y,z){
  const g = new THREE.BoxGeometry(gridSize*0.95,gridSize*0.95,gridSize*0.95);
  const m = new THREE.MeshPhongMaterial({
    color:0x001122,
    emissive:0x00f0ff,
    emissiveIntensity:0.4,
    transparent:true,
    opacity:0.85
  });
  const mesh = new THREE.Mesh(g,m);
  mesh.position.set(x,y,z);
  return mesh;
}

/* ========= HELPERS ========= */
function dist(a,b){
  return Math.hypot(a.x-b.x,a.y-b.y);
}

/* ========= STATE ========= */
let buildTimer = 0;
let lastTime = performance.now();

const HOLD = 500;     // ms
const PINCH = 0.08;  // mobile safe

/* ========= CORE ========= */
function onResults(res){
  const now = performance.now();
  const delta = now - lastTime;
  lastTime = now;

  bioCtx.clearRect(0,0,bioCanvas.width,bioCanvas.height);

  if(!res.multiHandLandmarks){
    dbgState.innerText = "NO HAND";
    buildTimer = 0;
    return;
  }

  const hand = res.multiHandLandmarks[0];
  const thumb = hand[4];
  const index = hand[8];

  // draw debug points
  bioCtx.fillStyle = "#00f0ff";
  [thumb,index].forEach(p=>{
    bioCtx.fillRect(
      p.x * bioCanvas.width - 5,
      p.y * bioCanvas.height - 5,
      10,10
    );
  });

  const pinchDist = dist(thumb,index);
  dbgPinch.innerText = pinchDist.toFixed(3);

  const pinching = pinchDist < PINCH;

  const world = new THREE.Vector3(
    (0.5 - index.x) * 22,
    (0.5 - index.y) * 16,
    0
  );

  const local = voxelGroup.worldToLocal(world.clone());
  const gx = Math.round(local.x/gridSize)*gridSize;
  const gy = Math.round(local.y/gridSize)*gridSize;
  const gz = 0;
  const key = `${gx.toFixed(1)},${gy.toFixed(1)},${gz.toFixed(1)}`;

  if(pinching){
    buildTimer += delta;
    dbgTimer.innerText = Math.floor(buildTimer);
    dbgState.innerText = "PINCHING";
    modeEl.innerText = "BUILD SYNC";

    if(buildTimer >= HOLD){
      if(!placed.has(key)){
        const cube = createCube(gx,gy,gz);
        voxelGroup.add(cube);
        placed.set(key,cube);
        countEl.innerText = placed.size;
      }
      dbgState.innerText = "BUILD";
      modeEl.innerText = "BUILDING";
    }
  } else {
    buildTimer = 0;
    dbgTimer.innerText = 0;
    dbgState.innerText = "TRACKING";
    modeEl.innerText = "TRACKING";
  }
}

/* ========= MEDIAPIPE ========= */
modeEl.innerText = "MOBILE HAND GESTURE ACTIVE";

const hands = new Hands({
  locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});

hands.setOptions({
  maxNumHands:1,
  modelComplexity:0,
  minDetectionConfidence:0.7,
  minTrackingConfidence:0.7
});

hands.onResults(onResults);

/* ðŸ”¥ FORCE BACK CAMERA */
const cam = new Camera(video,{
  onFrame: async ()=>{
    bioCanvas.width = video.videoWidth;
    bioCanvas.height = video.videoHeight;
    await hands.send({image:video});
  },
  width:960,
  height:720,
  facingMode:"environment"
});

cam.start();

/* ========= LOOP ========= */
function animate(){
  requestAnimationFrame(animate);
  renderer.render(scene,camera3D);
}
animate();
</script>

</body>
</html>
