<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PSY-LENS – Psychological State Observer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<style>
body{
  margin:0;
  background:#000;
  color:#00f0ff;
  font-family:monospace;
  overflow:hidden;
}
video,canvas{
  position:absolute;
  width:100vw;
  height:100vh;
  object-fit:cover;
}
canvas{pointer-events:none}
#ui{
  position:absolute;
  top:10px;
  left:10px;
  z-index:10;
  background:rgba(0,0,0,0.65);
  padding:12px;
  border-left:3px solid #00f0ff;
  font-size:12px;
}
.stat{color:#fff}
button{
  background:#001122;
  color:#00f0ff;
  border:1px solid #00f0ff;
  padding:5px 8px;
  margin-top:6px;
}
.warn{font-size:10px;color:#ff6666}
</style>
</head>

<body>

<div id="ui">
  <div><b>PSY-LENS</b></div>
  <div>Mode: <span id="mode" class="stat">FACIAL</span></div>
  <div>Arousal: <span id="arousal" class="stat">—</span></div>
  <div>Cognitive Load: <span id="load" class="stat">—</span></div>
  <div>Behavior Regulation: <span id="reg" class="stat">—</span></div>
  <div>Expression State: <span id="expr" class="stat">—</span></div>
  <button id="switchCam">Switch Camera</button>
  <div class="warn">⚠️ Observational system. Not diagnostic.</div>
</div>

<video id="video" autoplay playsinline muted></video>
<canvas id="overlay"></canvas>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>

<script>
/* ========= ELEMENTS ========= */
const video = document.getElementById("video");
const canvas = document.getElementById("overlay");
const ctx = canvas.getContext("2d");

const arousalEl = document.getElementById("arousal");
const loadEl = document.getElementById("load");
const regEl = document.getElementById("reg");
const exprEl = document.getElementById("expr");
const modeEl = document.getElementById("mode");

canvas.width = innerWidth;
canvas.height = innerHeight;

/* ========= CAMERA ========= */
let facing = "user";
let stream = null;
let bodyMode = false;

async function startCamera(){
  if(stream) stream.getTracks().forEach(t=>t.stop());
  stream = await navigator.mediaDevices.getUserMedia({
    video:{ facingMode:facing, width:1280, height:720 },
    audio:false
  });
  video.srcObject = stream;
  await video.play();
}

document.getElementById("switchCam").onclick = ()=>{
  facing = facing === "user" ? "environment" : "user";
  bodyMode = facing === "environment";
  modeEl.innerText = bodyMode ? "BODY" : "FACIAL";
  startCamera();
};

/* ========= FACEMESH ========= */
const faceMesh = new FaceMesh({
  locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`
});
faceMesh.setOptions({
  maxNumFaces:1,
  refineLandmarks:true,
  minDetectionConfidence:0.6,
  minTrackingConfidence:0.6
});

/* ========= STATE ========= */
let blink=0,lastBlink=0;
let prevX=null, headAgitation=0;
let prevFrame=null, motion=0;

/* ========= BODY ANALYSIS ========= */
function analyzeBody(){
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  const frame = ctx.getImageData(0,0,canvas.width,canvas.height);
  if(prevFrame){
    let diff=0;
    for(let i=0;i<frame.data.length;i+=40){
      diff+=Math.abs(frame.data[i]-prevFrame.data[i]);
    }
    motion = diff/100000;
  }
  prevFrame = frame;

  regEl.innerText = motion>0.6 ? "Unstable" : "Stable";
  arousalEl.innerText = motion>0.8 ? "Elevated" : "Moderate";
  loadEl.innerText = motion>0.7 ? "High" : "Moderate";
  exprEl.innerText = "—";
}

/* ========= CORE ========= */
faceMesh.onResults(res=>{
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(bodyMode){
    analyzeBody();
    return;
  }

  if(!res.multiFaceLandmarks) return;
  const lm = res.multiFaceLandmarks[0];
  const now = performance.now();

  const eyeDist = Math.abs(lm[159].y-lm[145].y);
  if(eyeDist<0.005 && now-lastBlink>300){
    blink++; lastBlink=now;
  }

  const nose = lm[1];
  if(prevX!==null) headAgitation+=Math.abs(nose.x-prevX);
  prevX=nose.x;

  const mouthOpen = Math.abs(lm[13].y-lm[14].y);
  const brow = Math.abs(lm[70].y-lm[159].y);

  arousalEl.innerText = blink>3 ? "Elevated" : "Moderate";
  loadEl.innerText = blink>3 || headAgitation>0.02 ? "High" : "Moderate";
  regEl.innerText = headAgitation>0.03 ? "Unstable" : "Stable";

  if(mouthOpen<0.01 && brow<0.02) exprEl.innerText="Tense";
  else if(mouthOpen>0.015) exprEl.innerText="Relaxed";
  else exprEl.innerText="Neutral";

  if(now%1000<16){ blink=0; headAgitation=0; }
});

/* ========= LOOP ========= */
async function loop(){
  await faceMesh.send({image:video});
  requestAnimationFrame(loop);
}

/* ========= START ========= */
startCamera().then(loop);
</script>

</body>
</html>
